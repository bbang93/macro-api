name: Deploy Macro API

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± (ì²˜ìŒë§Œ)
            mkdir -p ~/projects/macro-api
            cd ~/projects/macro-api

            # Git ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
            if [ ! -d ".git" ]; then
              git clone git@github.com:bbang93/macro-api.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi

            # Python 3.10 ì´ìƒ ì°¾ê¸°
            PYTHON_CMD=""
            for py in python3.12 python3.11 python3.10; do
              if command -v $py &> /dev/null; then
                PYTHON_CMD=$py
                echo "Found $py"
                break
              fi
            done

            if [ -z "$PYTHON_CMD" ]; then
              echo "Error: Python 3.10 or higher is required"
              exit 1
            fi

            # ê¸°ì¡´ venv ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„± (Python ë²„ì „ ë³€ê²½ì„ ìœ„í•´)
            rm -rf venv
            $PYTHON_CMD -m venv venv

            # ì˜ì¡´ì„± ì„¤ì¹˜
            source venv/bin/activate
            pip install --upgrade pip
            pip install -e ".[api]"

            # systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "ğŸ”„ Restarting macro-api service..."
            sudo systemctl restart macro-api

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "âœ… Service restart completed. Checking status..."
            sudo systemctl status macro-api --no-pager

            # ìµœê·¼ ë¡œê·¸ ì¶œë ¥
            echo "ğŸ“‹ Recent service logs:"
            sudo journalctl -u macro-api -n 20 --no-pager
